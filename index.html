<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝奏云直链解析</title>
    <style>
        body { display: none; }
    </style>
</head>
<body>
<script>

    // 解析URL参数
    function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            fid: params.get('fid'),
            pwd: params.get('pwd'),
            isNewd: params.get('isNewd') || 'https://innlab.lanzn.com/'
        };
    }

    // 执行JavaScript挑战的函数
    function executeChallenge(arg1) {
        try {
            var posList = [15, 35, 29, 24, 33, 16, 1, 38, 10, 9, 19, 31, 40, 27, 22, 23, 25, 13, 6, 11, 39, 18, 20, 8, 14, 21, 32, 26, 2, 30, 7, 4, 17, 5, 3, 28, 34, 37, 12, 36];
            var mask = "3000176000856006061501533003690027800375";
            var outPutList = [];
            var arg2 = '';
            var arg3 = '';

            for (var i = 0; i < arg1.length; i++) {
                var this_i = arg1[i];
                for (var j = 0; j < posList.length; j++) {
                    if (posList[j] == i + 1) {
                        outPutList[j] = this_i;
                    }
                }
            }

            arg2 = outPutList.join('');

            for (var i = 0; i < arg2.length && i < mask.length; i += 2) {
                var strChar = parseInt(arg2.slice(i, i + 2), 16);
                var maskChar = parseInt(mask.slice(i, i + 2), 16);
                var xorChar = (strChar ^ maskChar).toString(16);
                if (xorChar.length == 1) {
                    xorChar = '0' + xorChar;
                }
                arg3 += xorChar;
            }

            var expiredate = new Date();
            expiredate.setTime(expiredate.getTime() + 3600000);

            var theHost = location.host;
            var theHostSplit = theHost.split(".");
            var theHostSplitLength = theHostSplit.length;

            if (!/^(\d+\.)*\d+$/.test(theHost) && theHostSplitLength > 2) {
                theHost = theHostSplit[theHostSplitLength - 2] + "." + theHostSplit[theHostSplitLength - 1];
                if (["com.cn", "gov.cn", "org.cn", "net.cn", "com.my"].includes(theHost)) {
                    theHost = theHostSplit[theHostSplitLength - 3] + "." + theHost;
                }
            }

            return 'acw_sc__v2=' + arg3 + ';expires=' + expiredate.toGMTString() + ';max-age=3600;path=/;domain=' + theHost;

        } catch (error) {
            console.error('执行挑战失败:', error);
            return null;
        }
    }

    // 处理挑战页面的函数
    async function handleChallenge(htmlText) {
        // 提取arg1值
        const arg1Match = /var arg1 = '([^']+)'/.exec(htmlText);
        if (!arg1Match) {
            throw new Error('无法提取挑战参数');
        }

        const arg1 = arg1Match[1];
        console.log('检测到反爬挑战，arg1:', arg1);

        // 执行挑战获取cookie
        const challengeCookie = executeChallenge(arg1);
        if (!challengeCookie) {
            throw new Error('挑战执行失败');
        }

        console.log('生成的cookie:', challengeCookie);

        // 设置cookie
        document.cookie = challengeCookie;

        // 等待一小段时间让cookie生效
        await new Promise(resolve => setTimeout(resolve, 100));

        return true;
    }

    // 主解析函数
    async function parseLanzouLink(data) {
        console.log('解析参数:', data);
        if (data.url && data.url !== '') return data.url;

        const { pwd, isNewd, fid } = data;
        if (!fid) throw new Error('缺少必要参数: fid');

        // 通过代理服务器进行GET请求
        const getUrl = `/getfile/${fid}`;
        let getResponse = await fetch(getUrl);
        if (!getResponse.ok) throw new Error(`获取文件信息失败: ${getResponse.status}`);

        let htmlText = await getResponse.text();

        // 检查是否是挑战页面
        if (htmlText.includes('acw_sc__v2') && htmlText.includes('arg1')) {
            console.log('检测到反爬挑战，正在处理...');

            // 处理挑战
            await handleChallenge(htmlText);

            // 使用cookie重新请求
            getResponse = await fetch(getUrl, {
                headers: {
                    'Cookie': document.cookie
                }
            });

            if (!getResponse.ok) throw new Error(`重新请求失败: ${getResponse.status}`);

            htmlText = await getResponse.text();

            // 再次检查是否还是挑战页面
            if (htmlText.includes('acw_sc__v2') && htmlText.includes('arg1')) {
                throw new Error('挑战处理失败，请刷新页面重试');
            }
        }

        const urlMatch = /url\s*:\s*['"]([^'"]+?)['"],/.exec(htmlText);
        if (!urlMatch) throw new Error('无法提取文件URL');
        const fileurl = urlMatch[1];

        // 提取sign值
        const signRegex = /'sign':'([^']+)'/g;
        let signs = [];
        let match;
        while ((match = signRegex.exec(htmlText)) !== null) signs.push(match[1]);
        if (signs.length < 2) throw new Error('无法提取有效的sign值');

        // 通过代理服务器进行POST请求
        const postResponse = await fetch(`/getfile${fileurl}`, {
            method: 'POST',
            headers: {
                'Referer': window.location.origin + getUrl,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                action: "downprocess",
                sign: signs[1],
                p: pwd || '',
                kd: 1
            })
        });

        if (!postResponse.ok) throw new Error(`提交验证信息失败: ${postResponse.status}`);
        const postDataJson = await postResponse.json();

        if (postDataJson.zt == '1') {
            return `${postDataJson.dom}/file/${postDataJson.url}`;
        } else {
            throw new Error(postDataJson.inf || '文件解析失败');
        }
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const params = getQueryParams();
            const downloadUrl = await parseLanzouLink(params);
            console.log('解析成功，正在跳转:', downloadUrl);
            window.location.href = downloadUrl;
        } catch (error) {
            console.error('解析失败:', error);
            // 如果解析失败，显示一个极简的错误信息
            document.body.innerHTML = `<div style="text-align:center;margin-top:50px;color:red">解析失败: ${error.message}</div>`;
            document.body.style.display = 'block';
        }
    });
</script>
</body>
</html>
